services:
  mediabot-init:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PUID: ${PUID:-1000}
        PGID: ${PGID:-1000}
    image: mediabot-local:latest
    pull_policy: never
    container_name: mediabot-init
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    user: "0:0"
    volumes:
      - /docker/mediabot/downloads:/data/downloads
      - /docker/mediabot/saved_videos:/data/saved_videos
      - /docker/mediabot/db:/data/db
    restart: "no"
    command:
      - sh
      - -c
      - |
        set -e
        mkdir -p /data/downloads /data/saved_videos /data/db
        chown -R "${PUID:-1000}:${PGID:-1000}" /data

  mediabot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PUID: ${PUID:-1000}
        PGID: ${PGID:-1000}
    image: mediabot-local:latest
    pull_policy: never
    container_name: mediabot
    depends_on:
      mediabot-init:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - SUPER_ADMIN_CHAT_ID=${SUPER_ADMIN_CHAT_ID}
      - DOWNLOAD_DIR=/data/downloads
      - SAVED_VIDEOS_DIR=/data/saved_videos
      - DB_PATH=/data/db/users.db
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=America/Monterrey
    volumes:
      - /docker/mediabot/downloads:/data/downloads
      - /docker/mediabot/saved_videos:/data/saved_videos
      - /docker/mediabot/db:/data/db
    restart: unless-stopped
