services:
  mediabot-init:
    image: rafavg77/multimedia-downloader-bot:latest
    pull_policy: always
    container_name: mediabot-init
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    user: "0:0"
    volumes:
      - /docker/mediabot/downloads:/data/downloads
      - /docker/mediabot/saved_videos:/data/saved_videos
      - /docker/mediabot/db:/data/db
    restart: "no"
    command:
      - sh
      - -c
      - |
        set -e
        mkdir -p /data/downloads /data/saved_videos /data/db
        chown -R "${PUID:-1000}:${PGID:-1000}" /data

  mediabot:
    image: rafavg77/multimedia-downloader-bot:latest
    pull_policy: always
    container_name: mediabot
    depends_on:
      mediabot-init:
        condition: service_completed_successfully
    environment:
      - BOT_TOKEN=${BOT_TOKEN:?Set BOT_TOKEN in Portainer stack env vars}
      - SUPER_ADMIN_CHAT_ID=${SUPER_ADMIN_CHAT_ID:-}
      - DOWNLOAD_DIR=/data/downloads
      - SAVED_VIDEOS_DIR=/data/saved_videos
      - DB_PATH=/data/db/users.db
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=America/Monterrey
    volumes:
      - /docker/mediabot/downloads:/data/downloads
      - /docker/mediabot/saved_videos:/data/saved_videos
      - /docker/mediabot/db:/data/db
    restart: unless-stopped